<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Bot - Dashboard Principal</title>
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <div class="layout-hybrid">
        <!-- Sidebar Navigation -->
        <div class="hybrid-sidebar">
            <div class="sidebar-logo">
                <div class="logo">
                    <div class="logo-icon">üî•</div>
                    <div class="logo-text">
                        <h1>Phoenix Bot</h1>
                        <p>v2.0 - Production</p>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-navigation">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <div class="sidebar-nav-item active" onclick="navigateTo('index.html')">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-text">Dashboard</span>
                    </div>
                    <div class="sidebar-nav-item" onclick="navigateTo('streamers.html')">
                        <span class="nav-icon">üéÆ</span>
                        <span class="nav-text">Streamers</span>
                    </div>
                    <div class="sidebar-nav-item" onclick="navigateTo('analytics.html')">
                        <span class="nav-icon">üìà</span>
                        <span class="nav-text">Analyses</span>
                    </div>
                    <div class="sidebar-nav-item" onclick="navigateTo('admin.html')">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span class="nav-text">Administration</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Syst√®me</div>
                    <div class="sidebar-nav-item" onclick="navigateTo('logs.html')">
                        <span class="nav-icon">üìã</span>
                        <span class="nav-text">Logs</span>
                    </div>
                    <div class="sidebar-nav-item" onclick="navigateTo('settings.html')">
                        <span class="nav-icon">üîß</span>
                        <span class="nav-text">Param√®tres</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-stats">
                <div class="sidebar-stat">
                    <div class="sidebar-stat-value" data-stat="servers">--</div>
                    <div class="sidebar-stat-label">Serveurs</div>
                </div>
                <div class="sidebar-stat">
                    <div class="sidebar-stat-value" data-stat="users">--</div>
                    <div class="sidebar-stat-label">Utilisateurs</div>
                </div>
                <div class="sidebar-stat">
                    <div class="sidebar-stat-value" data-stat="streamers">--</div>
                    <div class="sidebar-stat-label">Streamers</div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="hybrid-header">
            <div class="header-title">
                <h2>Dashboard Principal</h2>
                <p class="header-subtitle">Vue d'ensemble de votre bot Discord Phoenix</p>
            </div>
            <div class="header-status">
                <div class="status-indicator" id="api-status">
                    <span>‚ùå</span>
                    <span>API Disconnected</span>
                </div>
                <div class="status-indicator" id="bot-status">
                    <span>‚ö†Ô∏è</span>
                    <span>Bot Status Unknown</span>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="hybrid-nav">
            <button class="nav-tab active">
                <span>üìä</span>
                <span>Vue d'ensemble</span>
            </button>
            <button class="nav-tab" onclick="navigateTo('analytics.html')">
                <span>üìà</span>
                <span>Analyses</span>
            </button>
            <button class="nav-tab" onclick="navigateTo('streamers.html')">
                <span>üéÆ</span>
                <span>Streamers</span>
            </button>
            <button class="nav-tab" onclick="navigateTo('admin.html')">
                <span>‚ö°</span>
                <span>Administration</span>
            </button>
            <button class="nav-tab" onclick="navigateTo('settings.html')">
                <span>üîß</span>
                <span>Configuration</span>
            </button>
        </div>

        <!-- Main Content -->
        <div class="hybrid-main">
            <!-- Connection Status -->
            <div class="connection-panel">
                <div class="connection-title">üîó √âtat de la Connexion</div>
                <div class="connection-info" id="connection-output">Initialisation...</div>
            </div>

            <!-- Main Stats Grid -->
            <div class="stats-grid">
                <div class="main-stat-card">
                    <div class="stat-value" data-stat="servers">--</div>
                    <div class="stat-label">Serveurs Discord</div>
                    <div class="stat-description">Serveurs o√π le bot est pr√©sent</div>
                </div>
                <div class="main-stat-card">
                    <div class="stat-value" data-stat="users">--</div>
                    <div class="stat-label">Utilisateurs</div>
                    <div class="stat-description">Total des membres sur tous les serveurs</div>
                </div>
                <div class="main-stat-card">
                    <div class="stat-value" data-stat="streamers">--</div>
                    <div class="stat-label">Streamers</div>
                    <div class="stat-description">Streamers configur√©s / En direct</div>
                </div>
                <div class="main-stat-card">
                    <div class="stat-value" data-stat="uptime">--</div>
                    <div class="stat-label">Uptime</div>
                    <div class="stat-description">Temps de fonctionnement du bot</div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Overview Card -->
                <div class="main-card">
                    <h3>üìä Vue d'Ensemble</h3>
                    <div class="overview-content">
                        <div class="overview-section">
                            <h4>üöÄ Statut du Bot</h4>
                            <div class="status-list" id="bot-status-list">
                                <div class="status-item">
                                    <span class="status-dot loading"></span>
                                    <span>Connexion Discord: V√©rification...</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-dot loading"></span>
                                    <span>API Twitch: V√©rification...</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-dot loading"></span>
                                    <span>Base de donn√©es: V√©rification...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overview-section">
                            <h4>üìà Activit√© R√©cente</h4>
                            <div class="activity-list" id="recent-activity">
                                <div class="activity-item">
                                    <span class="activity-time">--:--</span>
                                    <span class="activity-text">Dashboard initialis√©</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Card -->
                <div class="action-panel">
                    <div class="main-card" style="padding: 24px;">
                        <h3>‚ö° Actions Rapides</h3>
                        <button class="btn" onclick="refreshAllData()">
                            <span>üîÑ</span>
                            <span>Actualiser Tout</span>
                        </button>
                        <button class="btn" onclick="checkStreams()">
                            <span>üîç</span>
                            <span>V√©rifier Streams</span>
                        </button>
                        <button class="btn" onclick="testConnections()">
                            <span>üß™</span>
                            <span>Test Connexions</span>
                        </button>
                        <button class="btn" onclick="navigateTo('streamers.html')">
                            <span>üéÆ</span>
                            <span>G√©rer Streamers</span>
                        </button>
                    </div>

                    <!-- System Info Card -->
                    <div class="main-card" style="padding: 24px;">
                        <h3>‚ÑπÔ∏è Informations Syst√®me</h3>
                        <div class="system-info" id="system-info">
                            <div class="info-item">
                                <span class="info-label">Version:</span>
                                <span class="info-value">Phoenix Bot v2.0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Ping API:</span>
                                <span class="info-value" id="api-ping">--ms</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">M√©moire:</span>
                                <span class="info-value" id="memory-usage">--MB</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Derni√®re MAJ:</span>
                                <span class="info-value" id="last-update">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/phoenix-unified-api.js"></script>
    <script src="/js/dashboard-navigation.js"></script>
    <script>
    window.addEventListener('load', async () => {
        if (window.phoenixAPI) {
            // S'abonner aux mises √† jour
            phoenixAPI.onUpdate((state) => {
                if (state.stats) {
                    updateDashboardStats(state.stats);
                }
            });
        }
    });

    function updateDashboardStats(stats) {
        // Mise √† jour automatique des stats
        console.log('Stats mises √† jour', stats);
    }

    async function refreshAllData() {
        try {
            await phoenixAPI.loadAllData();
            phoenixAPI.showNotification('Donn√©es actualis√©es', 'success');
        } catch (error) {
            phoenixAPI.showNotification(error.message, 'error');
        }
    }

    async function checkStreams() {
        try {
            await phoenixAPI.checkStreams();
        } catch (error) {
            phoenixAPI.showNotification(error.message, 'error');
        }
    }

    async function testConnections() {
        phoenixAPI.log('Test des connexions...', 'info');
        
        try {
            await phoenixAPI.testConnection();
            await phoenixAPI.testTwitchAPI();
        } catch (error) {
            phoenixAPI.showNotification(error.message, 'error');
        }
    }
    

// Fonction √† appeler au chargement de la page
async function loadGuildInfo() {
    if (!window.phoenixAPI || !phoenixAPI.isConnected) {
        return;
    }

    try {
        const response = await phoenixAPI.request('/api/guild-info');
        
        if (response.success) {
            updateGuildHeader(response.guild);
            updateGuildStats(response.stats);
        }
    } catch (error) {
        console.error('Erreur chargement infos serveur:', error);
    }
}

// Mettre √† jour le header avec les infos du serveur
function updateGuildHeader(guild) {
    // Mettre √† jour le titre
    const headerTitle = document.querySelector('.header-title h2');
    if (headerTitle) {
        const currentPage = headerTitle.textContent;
        headerTitle.innerHTML = `
            ${currentPage}
            <span style="font-size: 0.7em; color: #00ffff; margin-left: 10px;">
                ‚Ä¢ ${guild.name}
            </span>
        `;
    }

    // Ajouter l'ic√¥ne du serveur dans la sidebar
    const sidebarLogo = document.querySelector('.sidebar-logo .logo');
    if (sidebarLogo && guild.icon) {
        const guildIcon = document.createElement('img');
        guildIcon.src = guild.icon;
        guildIcon.alt = guild.name;
        guildIcon.style.cssText = `
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #00ffff;
            margin-bottom: 10px;
        `;
        sidebarLogo.insertBefore(guildIcon, sidebarLogo.firstChild);
    }

    // Mettre √† jour le titre de la page
    document.title = `${guild.name} - Phoenix Bot Dashboard`;
}

// Mettre √† jour les stats du serveur
function updateGuildStats(stats) {
    if (!stats) return;

    // Afficher les stats affili√©s si disponible
    const statsContainer = document.querySelector('.sidebar-stats');
    if (statsContainer && stats.affiliatedStreamers !== undefined) {
        const affiliatedStat = document.createElement('div');
        affiliatedStat.className = 'sidebar-stat';
        affiliatedStat.innerHTML = `
            <div class="sidebar-stat-value">${stats.affiliatedStreamers}</div>
            <div class="sidebar-stat-label">Affili√©s</div>
        `;
        statsContainer.appendChild(affiliatedStat);
    }
}

// Ajouter au chargement de la page (dans window.addEventListener('load'))
window.addEventListener('load', async () => {
    if (window.phoenixAPI) {
        phoenixAPI.onUpdate((state) => {
            if (state.streamers) {
                streamersData = state.streamers;
                updateAllViews();
            }
        });
        
        // Charger les infos du serveur
        await loadGuildInfo();
        
        // Charger les streamers
        await loadStreamers();
    }
});

// Fonction pour afficher un badge "Serveur actuel"
function addGuildBadge() {
    const header = document.querySelector('.hybrid-header .header-title');
    if (!header) return;

    const badge = document.createElement('div');
    badge.style.cssText = `
        display: inline-block;
        background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
        border: 2px solid #00ffff;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        margin-left: 10px;
        vertical-align: middle;
    `;
    badge.textContent = 'üìå Dashboard de ce serveur';
    
    const subtitle = header.querySelector('.header-subtitle');
    if (subtitle) {
        subtitle.appendChild(badge);
    }
}
</script>
</body>
</html>